"use strict";(self.webpackChunkreubenliengaard_github_io=self.webpackChunkreubenliengaard_github_io||[]).push([[1799],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>g});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=r.createContext({}),c=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=c(e.components);return r.createElement(l.Provider,{value:t},e.children)},p="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},m=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),p=c(n),m=a,g=p["".concat(l,".").concat(m)]||p[m]||d[m]||o;return n?r.createElement(g,i(i({ref:t},u),{},{components:n})):r.createElement(g,i({ref:t},u))}));function g(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,i=new Array(o);i[0]=m;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[p]="string"==typeof e?e:a,i[1]=s;for(var c=2;c<o;c++)i[c]=n[c];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}m.displayName="MDXCreateElement"},6557:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>p,frontMatter:()=>o,metadata:()=>s,toc:()=>c});var r=n(7462),a=(n(7294),n(3905));const o={sidebar_position:1},i="Coreos sensor container with butane",s={unversionedId:"monitoring/coreos-sensor-container-with-butane",id:"monitoring/coreos-sensor-container-with-butane",title:"Coreos sensor container with butane",description:"To do",source:"@site/docs/monitoring/coreos-sensor-container-with-butane.md",sourceDirName:"monitoring",slug:"/monitoring/coreos-sensor-container-with-butane",permalink:"/docs/monitoring/coreos-sensor-container-with-butane",draft:!1,tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1},sidebar:"tutorialSidebar",previous:{title:"Monitoring",permalink:"/docs/category/monitoring"},next:{title:"Mosquitto and influxdb with podman play kube",permalink:"/docs/monitoring/mosquitto-and-influxdb-with-podman-play-kube"}},l={},c=[{value:"To do",id:"to-do",level:2},{value:"Install stuff",id:"install-stuff",level:3},{value:"Make working directory and change to it",id:"make-working-directory-and-change-to-it",level:3},{value:"Download image",id:"download-image",level:3},{value:"Rename image to simpler name",id:"rename-image-to-simpler-name",level:3},{value:"Create rpict.bu",id:"create-rpictbu",level:3},{value:"Transpile butane file into an ignition file",id:"transpile-butane-file-into-an-ignition-file",level:3},{value:"Test",id:"test",level:3},{value:"Setup the correct SELinux label to allow access to the config",id:"setup-the-correct-selinux-label-to-allow-access-to-the-config",level:3},{value:"Start a Fedora CoreOS virtual machine",id:"start-a-fedora-coreos-virtual-machine",level:3},{value:"Destroy",id:"destroy",level:3},{value:"Write to disk",id:"write-to-disk",level:3},{value:"Reference",id:"reference",level:2}],u={toc:c};function p(e){let{components:t,...n}=e;return(0,a.kt)("wrapper",(0,r.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"coreos-sensor-container-with-butane"},"Coreos sensor container with butane"),(0,a.kt)("h2",{id:"to-do"},"To do"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"setup MQTT gateway"),(0,a.kt)("li",{parentName:"ul"},"write CoreOS to SD and boot pi with external monitor"),(0,a.kt)("li",{parentName:"ul"},"test whether /dev/ttyAMA0 is accesible with CoreOS on RPI4")),(0,a.kt)("h3",{id:"install-stuff"},"Install stuff"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"sudo dnf install -y rpi-imager coreos-installer butane ignition-validate\n")),(0,a.kt)("h3",{id:"make-working-directory-and-change-to-it"},"Make working directory and change to it"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"mkdir ~/coreos\ncd ~/coreos\n")),(0,a.kt)("h3",{id:"download-image"},"Download image"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"coreos-installer download -p qemu -f qcow2.xz --decompress\n")),(0,a.kt)("h3",{id:"rename-image-to-simpler-name"},"Rename image to simpler name"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"mv *.qcow2 fedora-coreos.qcow2\n")),(0,a.kt)("h3",{id:"create-rpictbu"},"Create rpict.bu"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},'variant: fcos\nversion: 1.4.0\npasswd:\n  users:\n    - name: core\n      ssh_authorized_keys:\n        - ssh-rsa AAAA...\nsystemd:\n  units:\n    - name: serial-getty@ttyS0.service\n      dropins:\n      - name: autologin-core.conf\n        contents: |\n          [Service]\n          # Override Execstart in main unit\n          ExecStart=\n          # Add new Execstart with `-` prefix to ignore failure\n          ExecStart=-/usr/sbin/agetty --autologin core --noclear %I $TERM\n          TTYVTDisallocate=no\n    - name: failure.service\n      enabled: true\n      contents: |\n        [Service]\n        Type=oneshot\n        ExecStart=/usr/bin/false\n        RemainAfterExit=yes\n\n        [Install]\n        WantedBy=multi-user.target\n    - name: etcd-member.service\n      enabled: true\n      contents: |\n        [Unit]\n        Description=Run a single node etcd\n        After=network-online.target\n        Wants=network-online.target\n\n        [Service]\n        ExecStartPre=mkdir -p /var/lib/rpict2mqtt\n        ExecStartPre=-/bin/podman kill rpict2mqtt\n        ExecStartPre=-/bin/podman rm rpict2mqtt\n        ExecStartPre=-/bin/podman pull docker.io/gtricot/rpict-mqtt:latest\n        ExecStart=/bin/podman run --name rpict2mqtt \\\n                           --device=/dev/ttyAMA0:/dev/ttyAMA0 \\\n                            -e MQTT_URL="mqtt://my_mqtt_broker:1883" \\\n                           -e MQTT_USER="my-super-user" \\\n                           -e MQTT_PASSWORD="my-secret-password" \\\n                           -e MQTT_BASE_TOPIC="custom-rpict-topic" \\\n                           -e ABSOLUTE_VALUES=true \\\n                           -e SENSOR_VALUE_THRESHOLD=2 \\\n                            gtricot/rpict-mqtt\n        ExecStop=/bin/podman stop rpict2mqtt\n\n        [Install]\n        WantedBy=multi-user.target\nstorage:\n  files:\n    - path: /etc/hostname\n      mode: 0644\n      contents:\n        inline: |\n          tutorial\n    - path: /etc/profile.d/systemd-pager.sh\n      mode: 0644\n      contents:\n        inline: |\n          # Tell systemd to not use a pager when printing information\n          export SYSTEMD_PAGER=cat\n')),(0,a.kt)("h3",{id:"transpile-butane-file-into-an-ignition-file"},"Transpile butane file into an ignition file"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"butane --pretty --strict rpict.bu --output rpict.ign\n")),(0,a.kt)("h3",{id:"test"},"Test"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"ignition-validate rpict.ign && echo 'Success!'\n")),(0,a.kt)("h3",{id:"setup-the-correct-selinux-label-to-allow-access-to-the-config"},"Setup the correct SELinux label to allow access to the config"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"chcon --verbose --type svirt_home_t rpict.ign\n")),(0,a.kt)("h3",{id:"start-a-fedora-coreos-virtual-machine"},"Start a Fedora CoreOS virtual machine"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'virt-install --name=fcos --vcpus=2 --ram=2048 --os-variant=fedora-coreos-stable \\\n    --import --network=bridge=virbr0 --graphics=none \\\n    --qemu-commandline="-fw_cfg name=opt/com.coreos/config,file=${PWD}/rpict.ign" \\\n    --disk=size=20,backing_store=${PWD}/fedora-coreos.qcow2\n')),(0,a.kt)("h3",{id:"destroy"},"Destroy"),(0,a.kt)("p",null,"CTRL + ] to exit kvm\nto destroy run\nvirsh destroy fcos\nvirsh undefine --remove-all-storage fcos"),(0,a.kt)("h3",{id:"write-to-disk"},"Write to disk"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"FCOSDISK=/dev/sdX\nsudo coreos-installer install --architecture=aarch64 -i config.ign \n")),(0,a.kt)("h2",{id:"reference"},"Reference"),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"https://docs.fedoraproject.org/en-US/fedora-coreos/provisioning-raspberry-pi4/"},"FedoraOnRpi")))}p.isMDXComponent=!0}}]);